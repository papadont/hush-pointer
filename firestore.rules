rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Read only own screenshots; write-only otherwise.
    match /screenshots/{docId} {
      allow read: if request.auth != null && resource.data.uid == request.auth.uid;
      allow update, delete: if false;
      allow create: if isValidScreenshotCreate();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }

  function isValidScreenshotCreate() {
    return isSignedIn()
      && hasValidShape()
      && hasValidCoreValues();
  }

  function isSignedIn() {
    return request.auth != null
      && request.resource.data.uid is string
      && request.resource.data.uid == request.auth.uid;
  }

  function hasValidShape() {
    let base = ["uid", "kind", "image", "timestamp", "scheme", "mode", "targetSize", "glowMode", "pointerGuide"];
    let finishOnly = ["score", "hits", "miss", "median", "best", "perfectBonus"];
    let painterOnly = ["paintScore", "paintStrokes", "ink", "eraserMode"];

    return request.resource.data.keys().hasAll(base)
      && (
        (request.resource.data.kind == "finish"
          && request.resource.data.keys().hasOnly(base.concat(finishOnly)))
        ||
        (request.resource.data.kind == "painter"
          && request.resource.data.keys().hasOnly(base.concat(painterOnly)))
      );
  }

  function hasValidCoreValues() {
    return request.resource.data.kind in ["finish", "painter"]
      && request.resource.data.image is string
      && request.resource.data.image.size() > 100
      && request.resource.data.image.size() <= 900000
      && request.resource.data.image.matches('^data:image\\/png;base64,[A-Za-z0-9+/=]+$')
      && request.resource.data.timestamp == request.time
      && request.resource.data.scheme in ["default", "moss", "warm", "dusk", "dark"]
      && request.resource.data.mode in ["left", "right", "random"]
      && request.resource.data.targetSize is int
      && request.resource.data.targetSize >= 2
      && request.resource.data.targetSize <= 320
      && request.resource.data.glowMode is bool
      && request.resource.data.pointerGuide is bool
      && (
        (request.resource.data.kind == "finish"
          && request.resource.data.score is number
          && request.resource.data.hits is number
          && request.resource.data.miss is number
          && request.resource.data.median is number
          && request.resource.data.best is number
          && request.resource.data.perfectBonus is number)
        ||
        (request.resource.data.kind == "painter"
          && request.resource.data.paintScore is number
          && request.resource.data.paintStrokes is number
          && request.resource.data.ink is number
          && request.resource.data.eraserMode is bool)
      );
  }
}
